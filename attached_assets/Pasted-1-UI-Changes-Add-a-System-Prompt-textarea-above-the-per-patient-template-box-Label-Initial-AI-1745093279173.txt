1. UI Changes
Add a “System Prompt” textarea above the per‑patient template box:

Label: “Initial AI Instructions”

Pre‑filled with your default system prompt (e.g. “You are a healthcare assistant that…”).

Add a “Template Variables” editor below the batch/patient selectors:

A table or list where each row is a placeholder, with columns:

Placeholder (e.g. {name})

Description (e.g. “Patient’s full name”)

Example value (optional)

Buttons: “Add Variable” / “Remove” on each row.

Keep the existing per‑patient template editor as is.

Regenerate button now reloads and applies:

The current system prompt

The current variables list

The current per‑patient template

2. Storage & API Changes
Persist three pieces of data keyed by batchId (or global fallback):

systemPrompt (string)

templateVariables (array of { placeholder, description })

(Existing) patientTemplate

On load of the sandbox page, fetch all three and populate the UI.

On save of each section, call:

POST /api/sandbox/system-prompt → saves systemPrompt

POST /api/sandbox/variables → saves templateVariables

POST /api/sandbox/patient-template → saves patientTemplate

3. Regeneration Logic
In your regenerate endpoint, assemble the final prompt in three steps:

Start with the saved systemPrompt

Append a dynamically generated “Variables” section, e.g.:

python-repl
Copy
Edit
Available placeholders:
{name} — Patient’s full name
{age} — Patient’s age
...
Append the saved patientTemplate, replacing placeholders with real data (or leaving them for the AI to fill in).

Send that concatenated string into your OpenAI call.

Fallbacks: if any section isn’t customized, default back to the hard‑coded original.

4. Security & Internals
Sanitize all user‑entered text in systemPrompt and variable descriptions to avoid injection.

Since this is internal, you can expose full editing controls—but cap the maximum lengths (e.g. system prompt ≤ 2000 chars, each description ≤ 200 chars).

5. Testing & Validation
Modify the system prompt to something trivial (e.g. “You are a test”). Regenerate and confirm the AI sees that change.

Add a fake placeholder {foo} with description “Test var,” use it in a patient template, regenerate, and ensure the AI is told about {foo}.

Remove a variable, regenerate, and confirm it no longer appears.

Reload the sandbox page and verify all edits persist.